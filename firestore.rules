rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuth() {
      return request.auth != null;
    }
    function isRole(role) {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    function isOneOfRoles(roles) {
      return isAuth() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in roles;
    }
    function isAdmin() {
      return isRole('admin');
    }
    function isManager() {
      return isOneOfRoles(['admin', 'manager']);
    }

    // Publicly readable collections
    match /menuItems/{itemId} {
      allow read: if true;
      allow write: if isManager();
    }
    match /tables/{tableId} {
      allow read: if true;
      allow write: if isOneOfRoles(['admin', 'manager', 'waiter']);
    }
    
    // User profiles can be read by anyone for the login screen, but only written by the user themselves or an admin.
    match /users/{userId} {
      allow read: if true;
      allow create: if isAuth();
      allow update: if isAuth() && (request.auth.uid == userId || isAdmin());
    }

    // Orders can be created by anyone, but only read/updated by staff.
    match /orders/{orderId} {
      allow create: if true;
      allow read, update, delete: if isOneOfRoles(['admin', 'manager', 'cashier', 'kitchen', 'waiter']);
    }

    // Stock items require manager/admin privileges.
    match /stockItems/{itemId} {
      allow read, write: if isManager();
    }

    // Inventory logs are write-only for managers/admins to ensure audit trail integrity.
    match /inventoryLogs/{logId} {
      allow read: if isManager();
      allow create: if isManager();
      allow update, delete: if false;
    }
  }
}
