/**
 * # Core Philosophy
 * This ruleset enforces a strict user-ownership model for customer data and a
 * role-based model for administrative data (menu items, staff roles). The primary
 * goals are to ensure that customers can only access their own information and orders,
 * while allowing public read access to the restaurant menu. Staff members are granted
 * privileged write access to administrative collections.
 *
 * # Data Structure
 * - `/customers/{customerId}`: A user's own profile document. The document ID must
 *   match the user's Firebase Authentication UID.
 * - `/customers/{customerId}/orders/{orderId}`: A subcollection containing orders
 *   that belong exclusively to the parent customer.
 * - `/menu_items/{menuItemId}`: A top-level collection of all menu items. This
 *   data is public to all users, including those not signed in.
 * - `/roles_staff/{uid}`: A collection where the existence of a document indicates
 *   that a user is a staff member. This is used for role-based access control.
 *
 * # Key Security Decisions
 * - **Strict User Scoping**: All data under `/customers/{customerId}` is strictly
 *   limited to the authenticated user whose UID matches `{customerId}`.
 * - **No User Enumeration**: Listing documents in the top-level `/customers`
 *   collection is explicitly forbidden to prevent leaking user information.
 * - **Public Menu**: The `/menu_items` collection is publicly readable to allow
 *   any app client to display the menu.
 * - **Staff-Only Writes**: All modifications to `/menu_items` are restricted to
 *   users designated as staff.
 * - **Backend-Managed Roles**: The `/roles_staff` collection is not writable by any
 *   client. Staff roles must be managed by a trusted backend server using the
 *   Admin SDK to ensure security.
 *
 * # Denormalization for Authorization
 * To ensure fast and secure rules, authorization data is denormalized:
 * - The `Order` documents contain a `customerId` field, which is validated against
 *   the path to confirm ownership without needing extra `get()` calls.
 * - Staff roles are determined by the existence of a document in `/roles_staff/{uid}`,
 *   which is a fast `exists()` check. This avoids storing roles on user documents
 *   or in a separate complex structure.
 *
 * # Structural Segregation
 * Data is segregated by access pattern. Private user data is nested under `/customers`,
 * public data is in its own `/menu_items` collection, and administrative role
 * information is in `/roles_staff`. This separation simplifies rules and improves
 * query performance and security.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Checks for ownership on an existing document. Used for update and delete.
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    // Checks if the requesting user has a staff role document.
    function isStaff() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_staff/$(request.auth.uid));
    }
    
    /**
     * @description A Customer document, which represents a user's profile.
     * @path /customers/{customerId}
     * @allow (create) An authenticated user creates their own customer profile: `auth.uid == customerId`.
     * @deny (create) A user tries to create a profile for another user: `auth.uid != customerId`.
     * @deny (list) A user tries to list all documents in the `/customers` collection.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false;
      allow create: if isOwner(customerId) && request.resource.data.id == customerId;
      allow update: if isExistingOwner(customerId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(customerId);
      
      /**
       * @description An Order document, nested under the customer who placed it.
       * @path /customers/{customerId}/orders/{orderId}
       * @allow (create) The customer creates a new order for themselves: `auth.uid == customerId`.
       * @deny (get) A user tries to read another user's order.
       * @principle Enforces document ownership via path and validates relational integrity on create.
       */
      match /orders/{orderId} {
        allow get: if isOwner(customerId);
        allow list: if isOwner(customerId);
        allow create: if isOwner(customerId) && request.resource.data.customerId == customerId;
        allow update: if isExistingOwner(customerId) && request.resource.data.customerId == resource.data.customerId;
        allow delete: if isExistingOwner(customerId);
      }
    }
    
    /**
     * @description A MenuItem document, which is part of the public restaurant menu.
     * @path /menu_items/{menuItemId}
     * @allow (get) Any user, signed in or not, can read a menu item.
     * @allow (create) A staff member adds a new item to the menu.
     * @deny (update) A regular customer tries to change the price of a menu item.
     * @principle Allows public read access while restricting write operations to privileged roles (staff).
     */
    match /menu_items/{menuItemId} {
      allow get: if true;
      allow list: if true;
      allow create: if isStaff();
      allow update: if isStaff() && resource != null;
      allow delete: if isStaff() && resource != null;
    }
    
    /**
     * @description A document indicating a user has a Staff role. Existence implies the role.
     * @path /roles_staff/{uid}
     * @allow (none) No client is ever allowed to read or write to this collection.
     * @deny (create) A user attempts to grant themselves staff privileges.
     * @principle Secures role management by prohibiting all client-side modifications. Roles must be managed by a trusted backend.
     */
    match /roles_staff/{uid} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}